((e,t)=>{'object'==typeof exports&&'undefined'!=typeof module?t(exports):'function'==typeof define&&define.amd?define(['exports'],t):t((e=e||self).effector={})})(this,function(e){function t({node:e,child:t=[],from:n=[],scope:r={},meta:o={}}){return{from:n.map(P),seq:e,next:t.map(P),meta:o,scope:r}}function n(e){return e.compositeName?e.compositeName.fullName:e.domainName?e.domainName.fullName:e.id}function r(e){let t=0;const r=Object.values(e),o=ye-1,a=r.length-1;let i='combine(';for(const e of r){const r=t===o||a===t?'':', ';if(me(e)||he(e)||be(e)?i+=n(e)+r:i+=e.toString()+r,t+=1,''===r)break}return i+')'}function o(e,t,n){this.shortName=e,this.fullName=t,this.path=n}function a(e,t){let n,r;const a=e;return void 0===t?(n=0===e.length?[]:[e],r=e):0===e.length?(n=t.path,r=t.fullName):(n=t.path.concat([e]),r=0===t.fullName.length?e:t.fullName+'/'+e),new o(a,r,n)}function i(e){return e(this)}function s(){const e=this.indexOf();-1!==e&&(this.splice(e,1),this.indexOf=Ne,this.splice=Se)}function c({name:e,parent:r,config:o={}}){const s=je(),l=e||s,f=a(l,r),u=f.fullName,d=t({node:[B.emit({fullName:u})]}),p=(e,...t)=>p.create(e,u,t);return p.getType=(()=>u),p.create=(e=>(oe(p,e),e)),p.kind=C,p[O]=(()=>p),p.id=s,p.watch=((e,t)=>we(e,{scope:{trigger:e,handler:t},node:[le,B.run({fn:(e,{trigger:t,handler:r})=>r(e,n(t))})]})).bind(null,p),p.map=((e,t)=>{const n=c({name:e.shortName+' → *',parent:e.domainName});return we(e,{child:[n],scope:{handler:t},node:[B.compute({fn:(e,{handler:t})=>t(e)})]}),n}).bind(null,p),p.filter=function(e,t){const n=c({name:e.shortName+' →? *',parent:e.domainName});let r,o;return'object'==typeof t?(o={fn:t.fn},r=[B.filter({fn:function(e){function t(t,n){return e.apply(this,arguments)}return t.toString=(()=>e.toString()),t}((e,{fn:t})=>t(e))})]):(o={fn:t},r=[B.compute({fn:function(e){function t(t,n){return e.apply(this,arguments)}return t.toString=(()=>e.toString()),t}((e,{fn:t})=>t(e))}),B.filter({fn:e=>void 0!==e})]),we(e,{scope:o,child:[n],node:r}),n}.bind(null,p),p.prepend=((e,t)=>{const n=c({name:'* → '+e.shortName,parent:e.domainName});return we(n,{child:[e],scope:{handler:t},node:[B.compute({fn:(e,{handler:t})=>t(e)})]}),n}).bind(null,p),p.subscribe=((e,t)=>e.watch(e=>t.next(e))).bind(null,p),p.thru=i.bind(p),p.graphite=d,p.shortName=l,p.domainName=r,p.compositeName=f,p.defaultConfig=o,p}function l(e={}){void 0!==(null==e?void 0:e.ɔ)&&ue('object'==typeof e.ɔ&&null!==e.ɔ,"createStore: Second argument should be plain object, but you passed %s.",e.ɔ);const t=Object.assign({},e,'object'==typeof e.ɔ?e.ɔ:{});return delete t.ɔ,t}function f(e,t){const n='object'==typeof e?Object.assign({},l(t),e):l(t);return{config:n,name:'object'==typeof e||void 0===e?n.name:e}}function u(e,t={}){const{config:n,name:r}=f(e,t);return c({name:r,config:n})}function d(e){return A(e.plainState)}function p(e,t){const n=e.subscribers.get(t);void 0!==n&&(n(),e.subscribers.delete(t))}function m(e,t,r){const o=t,a=e.subscribers.get(o);return a&&a(),e.subscribers.set(o,we(o,{scope:{handler:r,state:e.plainState,trigger:o},child:[e],node:[B.compute({fn(e,{handler:t,state:r,trigger:o}){const a=t(A(r),e,n(o));if(void 0!==a)return M(r,a)}})]})),this}function h(e,t,r){const o='watch requires function handler';switch(r&&(null==t?void 0:t.kind)){case'store':case'event':case'effect':return E('function'==typeof r,o),t.watch(o=>r(d(e),o,n(t)));default:return E('function'==typeof t,o),b(e,t)}}function b(e,t){E('function'==typeof t,'Expected the listener to be a function');let n='Got initial error',r=d(e);try{t(r),n='Initial'}catch(e){console.error(e)}return we(e,{node:[le,B.run({fn(e){let n=null;if(e!==r){r=e;try{t(e)}catch(e){console.error(e),n='Got error'}}}})]})}function g(e){const{currentState:n,config:r,parent:o}=e,{name:s}=r,c=z(n),l=s||c.id,f=n,v=a(l,o),y=u('update '+l),N={graphite:t({scope:{state:c,oldState:n},node:[B.filter({fn:e=>void 0!==e}),B.update({store:c}),B.filter({fn:(e,t)=>e===t.oldState?0:(t.oldState=e,1)})]}),kind:q,id:c.id,shortName:l,domainName:o,defaultConfig:r,defaultState:f,plainState:c,subscribers:new Map,compositeName:v},S={compositeName:N.compositeName,graphite:N.graphite,kind:q,id:c.id,shortName:l,domainName:o,setState:(e,t)=>{const n=d(N),r='function'==typeof t?t(n,e):e;oe(S,r)},off:p.bind(null,N),watch:h.bind(null,N),updates:y,subscribe:b.bind(null,N),getState:d.bind(null,N),stateRef:c};return S.defaultConfig=r,S.reset=function(e,...t){for(const n of t)m.call(this,e,n,()=>e.defaultState);return this}.bind(S,N),S.on=m.bind(S,N),S.defaultState=f,S.map=function(e,t,n){let r,o='Got initial error';try{const a=e.getState();void 0!==a&&(r=t(a,n)),o='Initial'}catch(e){console.error(e)}const a=this({config:{name:e.shortName+' → *'},currentState:r,parent:e.domainName});return we(e,{child:[a],scope:{store:e,handler:t,state:a.stateRef},node:[B.compute({fn(e,{state:t,handler:n}){let r,o='Got error';try{r=n(e,A(t)),o=null}catch(e){console.error(e)}return r}}),ce]}),a}.bind(g,S),S.thru=i.bind(S),S.dispatch=(e=>e).bind(null),S[O]=function(e){const t={subscribe:t=>(E('object'==typeof t&&null!==t,'Expected the observer to be an object.'),b(e,e=>{t.next&&t.next(e)}))};return t[O]=function(){return this},t}.bind(null,N),xe({from:S,to:y}),S}function v(e,t={}){return E(void 0!==e,"createStore: First argument can't be undefined, use null instead."),g({currentState:e,config:l(t)})}function y(e,t){const n=Array.isArray(e)?ke(e,e=>e.slice(),[]):ke(e,e=>Object.assign({},e),{});return t?n.map(t):n}function N(e){const t={};for(const n in e){const r=e[n];t[n]=me(r)?r:g({currentState:r,config:{name:n}})}return t}function S(e,t){const n=g({currentState:t,parent:e.domainName,config:{name:e.shortName}});return n.on(e.done,(e,{result:t})=>t),n}function w(e,t){const n=g({currentState:t,parent:e.domainName,config:{name:e.shortName}});return n.on(e,(e,t)=>t),n}function x(...e){let t,n,r;E(e.length>0,'at least one argument required');{const r=e[e.length-1];'function'==typeof r?(n=e.slice(0,-1),t=r):n=e}e:{if(1===n.length){const e=n[0];if(!me(e)){r=e;break e}}r=n,t&&(t=Ee(t))}return y(r,t)}function j(){const e=new Promise((e,t)=>{this.rs=e,this.rj=t});e.anyway=(()=>e.then(()=>{},()=>{})),this.req=e}function k({name:e,parent:t,config:n}){const{handler:r}=n,o=c({name:e,parent:t,config:n}),a=o.create,i=c({name:o.shortName+' done',parent:t,config:n}),s=c({name:o.shortName+' fail',parent:t,config:n});i.graphite.seq.push(Ce),s.graphite.seq.push(Ce);let l=r||function(){return ue(0,'no thunk used in %s',this.getType()),Promise.resolve()}.bind(o);o.done=i,o.fail=s,o.use=(e=>(l=e,o));const f=()=>l;return o.use.getCurrent=f,o.kind=I,o.graphite.scope={done:i,fail:s,getHandler:f},o.graphite.seq.push(B.compute({fn:e=>'object'==typeof e&&null!==e&&'ɔ'in e?e.ɔ:{params:e,req:{rs(e){},rj(e){}}}}),B.run({fn:({params:e,req:t},{getHandler:n,done:r,fail:o})=>(((e,t,n,r)=>{let o,a,i=0;try{a=e(t)}catch(e){i=1,o=e}i?r(o):'object'!=typeof a||null===a||'function'!=typeof a.then?n(a):a.then(n,r)})(n(),e,function(e){const{event:t,params:n,handler:r}=this;ae(t,{handler:r,toHandler:e,result:{params:n,result:e}})}.bind({event:r,params:e,handler:t.rs}),function(e){const{event:t,params:n,handler:r}=this;ae(t,{handler:r,toHandler:e,result:{params:n,error:e}})}.bind({event:o,params:e,handler:t.rj})),e)})),o.create=((e,t,n)=>{const r=new j;return a({"ɔ":{params:e,req:r}},o.getType(),n),r.req}),o.pending=v(Boolean(0)).on(o,()=>Boolean(1)).reset(i).reset(s),o}var E=e=>{if(!e)throw Error('Minified exception occurred')},O=(()=>{var e,t=('undefined'!=typeof self?self:'undefined'!=typeof window?window:'undefined'!=typeof global?global:'undefined'!=typeof module?module:Function("","return this")()).Symbol;return'function'==typeof t?t.observable?e=t.observable:(e=t('observable'),t.observable=e):e='@@observable',e})();const q='store',C='event',I='effect';var F=Object.freeze({store:q,event:C,effect:I,domain:"domain"});const D=()=>{let e=0;return()=>(++e).toString(36)},H=D(),R=(e,t)=>({id:H(),type:e,group:'cmd',data:t}),B={barrier:({barrierID:e,priority:t="barrier"})=>R('barrier',{barrierID:e,priority:t}),compute:R.bind(null,'compute'),emit:R.bind(null,'emit'),filter:R.bind(null,'filter'),run:R.bind(null,'run'),tap:R.bind(null,'tap'),update:R.bind(null,'update')},G=(e,{deep:t}={})=>{const n=P(e);t&&n.next.forEach(e=>G(e,{deep:t})),n.from.forEach(e=>{const t=e.next.indexOf(n);-1!==t&&e.next.splice(t,1)}),n.from.length=0,n.next.length=0,n.seq.length=0,n.scope=null},P=e=>e.graphite||e,T=D(),z=e=>({id:T(),current:e}),A=({current:e})=>e,M=(e,t)=>e.current=t,_=D(),K=e=>{switch(e){case'child':return 0;case'pure':return 1;case'barrier':return 2;case'sampler':return 3;case'effect':return 4;default:return-1}};class U{constructor(e,t){this.value={current:e},this.parent=t}}class J{constructor(e,t,n,r){this.value=e,this.rank=t,this.left=n,this.right=r}}const L=e=>e?Q(e.left,e.right):null,Q=(e,t)=>{let n,r,o,a,i,s,c;for(;;){var l,f;if(n=t,!(r=e))return n;if(!n)return r;if(a=r.left,!W(o=r.value,n.value))return i=Q(r.right,n),(s=(null===(l=a)||void 0===l?void 0:l.rank)||0)>=(c=(null===(f=i)||void 0===f?void 0:f.rank)||0)?new J(o,c+1,a,i):new J(o,s+1,i,a);t=r,e=n}};class V{constructor(e){this.isChanged=1,this.isFailed=0,this.scope=e}}const W=(e,t)=>e.type===t.type?e.id>t.id:K(e.type)>K(t.type);let X=0,Y=null;const Z=new Set,$=e=>{Y=((e,t)=>Q(new J(e,1,null,null),t))(e,Y)},ee=({step:e,firstIndex:t,scope:n,resetStop:r},o)=>{const a=new V(e.scope);for(let r=t;r<e.seq.length&&!o.stop;r++){const i=e.seq[r];if(r===t)'barrier'===i.type&&Z.delete(i.data.barrierID);else switch(i.type){case'run':return void $({step:e,firstIndex:r,scope:n,resetStop:0,type:'effect',id:++X});case'barrier':{const t=i.data.barrierID;return void(Z.has(t)||(Z.add(t),$({step:e,firstIndex:r,scope:n,resetStop:0,type:i.data.priority,id:++X})))}}(0,ie[i.type])(a,i.data,n.value),o.stop=a.isFailed||!a.isChanged}if(!o.stop)for(let t=0;t<e.next.length;t++){const r=new U(A(n.value),n);$({step:e.next[t],firstIndex:0,scope:r,resetStop:1,type:'child',id:++X})}r&&(o.stop=0)};let te=0;const ne=(e,t)=>{$({step:P(e),firstIndex:0,scope:new U(t,null),resetStop:0,type:'pure',id:++X})},re=()=>{const e=te;te=1;const t={stop:0};let n;for(;Y;)n=Y.value,Y=L(Y),ee(n,t);te=e},oe=(e,t)=>{ne(e,t),re()},ae=(e,t)=>{ne(e,t),te||re()},ie={barrier(e,t,n){e.isFailed=0,e.isChanged=1},emit(e,t,n){},filter(e,t,n){const r=se({arg:A(n),val:e.scope,fn:t.fn});e.isChanged=!!r.result},run(e,t,n){const r=se({arg:A(n),val:e.scope,fn:t.fn});e.isFailed=r.err,M(n,r.result)},update(e,t,n){M(t.store,A(n))},compute(e,t,n){const r=se({arg:A(n),val:e.scope,fn:t.fn});e.isFailed=r.err,M(n,r.result)},tap(e,t,n){const r=se({arg:A(n),val:e.scope,fn:t.fn});e.isFailed=r.err}},se=({fn:e,arg:t,val:n})=>{const r={err:0,result:null};try{r.result=e(t,n)}catch(e){console.error(e),r.err=1}return r},ce=B.filter({fn:(e,{state:t})=>e!==A(t)&&void 0!==e}),le=B.compute({fn:e=>e});var fe=Object.freeze({filterChanged:ce,noop:le}),ue=()=>{};const de=e=>('function'==typeof e||'object'==typeof e&&null!==e)&&'kind'in e,pe=e=>t=>de(t)&&t.kind===e,me=pe(q),he=pe(C),be=pe(I),ge=pe("domain");var ve=Object.freeze({unit:de,store:me,event:he,effect:be,domain:ge});const ye=25,Ne=()=>-1,Se=()=>[],we=(e,n)=>xe({from:e,to:t(n)}),xe=e=>{const t=P(e.from),n=P(e.to);return t.next.push(n),(e=>{const t=e.parent.next,n={indexOf:t.indexOf.bind(t,e.child),splice:t.splice.bind(t)},r=s.bind(n);return r.unsubscribe=s.bind(n),r})({child:n,parent:t})},je=D(),ke=(e,t,n)=>{const o=[B.filter({fn:(e,{target:t,key:n})=>e!==A(t)[n]&&void 0!==e}),B.tap({fn(e,{isFresh:t,target:n,clone:r}){A(t)||(M(n,r(A(n))),M(t,1))}}),B.tap({fn(e,{target:t,key:n}){A(t)[n]=e}}),B.barrier({barrierID:_()}),B.compute({fn:(e,{isFresh:t,target:n})=>(M(t,0),A(n))})],a=t(n),i=g({currentState:a,config:{name:r(e)}}),s=z(0);for(const r in e){const c=e[r];me(c)?(n[r]=c.defaultState,a[r]=c.getState(),we(c,{scope:{key:r,clone:t,target:i.stateRef,isFresh:s},node:o,child:[i]})):a[r]=n[r]=c}return i.defaultShape=e,i.defaultState=n,i},Ee=e=>t=>e(...t),Oe=(e,t,n,r,o)=>(we(t,{scope:{state:e.stateRef,fn:n},child:[o],node:[!r&&le,!r&&B.barrier({barrierID:_(),priority:'sampler'}),B.compute({fn:n?(e,{state:t,fn:n})=>n(A(t),e):(e,{state:t})=>A(t)})].filter(Boolean)}),o),qe=e=>de(e)?e:y(e),Ce=B.run({fn:({handler:e,toHandler:t,result:n})=>(e(t),n)});class Ie{constructor(){this.events=new Set,this.effects=new Set,this.storages=new Set,this.domains=new Set}}const Fe=D();e.Kind=F,e.blocks=fe,e.clearNode=G,e.combine=x,e.createApi=((e,t)=>{const n={};for(const r in t){const o=t[r],a=n[r]=u(r);e.on(a,o)}return n}),e.createDomain=((e,t={})=>{const{config:n,name:r}=f(e,t);return function e({name:t,config:n={},parent:r,parentHooks:o}){const i=Fe(),s=a(t||'',r),f=new Ie,u=((e,t,n)=>{let r;return(r=n?(e=>({event:e.event.prepend(e=>e),effect:e.effect.prepend(e=>e),store:e.store.prepend(e=>e),domain:e.domain.prepend(e=>e)}))(n):(e=>({event:c({name:e.fullName+" event hook",parent:e}),effect:c({name:e.fullName+" effect hook",parent:e}),store:c({name:e.fullName+" store hook",parent:e}),domain:c({parent:e})}))(t)).domain.watch(t=>{e.domains.add(t)}),r.event.watch(t=>{e.events.add(t)}),r.store.watch(t=>{e.storages.add(t)}),r.effect.watch(t=>{e.effects.add(t)}),r})(f,s,o);return{compositeName:s,id:i,defaultConfig:n,getType:()=>s.fullName,onCreateEvent:e=>(f.events.forEach(e),u.event.watch(e)),onCreateEffect:e=>(f.effects.forEach(e),u.effect.watch(e)),onCreateStore:e=>(f.storages.forEach(e),u.store.watch(e)),onCreateDomain:e=>(f.domains.forEach(e),u.domain.watch(e)),event(e,t={}){const n=l(t),r=c({name:e,parent:s,config:n});return u.event(r),r},effect(e,t={}){const n=l(t),r=k({name:e,domainName:s.fullName,parent:s,config:n});return u.effect(r),r},domain(t,n={}){const r=l(n),o=e({name:t,parent:s,parentHooks:u,config:r});return u.domain(o),o},store(e,t={}){const n=l(t),r=g({currentState:e,parent:s,config:n});return u.store(r),r},kind:"domain"}}({name:void 0===r?'':r,config:n})}),e.createEffect=((e,t)=>{const{config:n,name:r}=f(e,t);return k({name:r,domainName:'',config:n})}),e.createEvent=u,e.createNode=t,e.createStore=v,e.createStoreObject=x,e.extract=((e,t)=>{let n;return y(n=t('defaultShape'in e?e.defaultShape:e.defaultState))}),e.forward=xe,e.fromObservable=(e=>{E('function'==typeof e||'object'==typeof e&&null!==e,'expect observable to be object or function');const t=O in e?e[O]():e;E('subscribe'in t,'expect observable to have .subscribe');const n=u(),r=G.bind(null,n,{});return t.subscribe({next:n,error:r,complete:r}),n}),e.invariant=E,e.is=ve,e.isDomain=ge,e.isEffect=be,e.isEvent=he,e.isStore=me,e.isUnit=de,e.launch=oe,e.restore=((e,t)=>me(e)?e:he(e)?w(e,t):be(e)?S(e,t):N(e)),e.restoreEffect=S,e.restoreEvent=w,e.restoreObject=N,e.sample=((e,t,n,r=0)=>{let o;void 0===t&&'source'in e&&(t=e.clock||e.sampler,n=e.fn,r=e.greedy,o=e.target,e=e.source),void 0===t&&(t=e);const a=qe(e),i=qe(t);return'boolean'==typeof n&&(r=n,n=void 0),(me(a)?me(i)?(e,t,n,r,o)=>{const a=A(e.stateRef);return Oe(e,t,n,r,o||g({currentState:n?n(a,A(t.stateRef)):a,config:{name:e.shortName},parent:e.domainName}))}:(e,t,n,r,o)=>Oe(e,t,n,r,o||c({name:e.shortName,parent:e.domainName})):(e,t,n,r,o)=>{o=o||c({name:e.shortName,parent:e.domainName});const a=z(0),i=z(),s=z();return we(e,{scope:{hasSource:a},node:[B.update({store:i}),B.tap({fn(e,{hasSource:t}){M(t,1)}})]}),we(t,{scope:{sourceState:i,clockState:s,hasSource:a,fn:n},child:[o],node:[B.update({store:s}),B.filter({fn:(e,{hasSource:t})=>A(t)}),!r&&B.barrier({barrierID:_(),priority:'sampler'}),B.compute({fn:n?(e,{sourceState:t,clockState:n,fn:r})=>r(A(t),A(n)):(e,{sourceState:t})=>A(t)})].filter(Boolean)}),o})(a,i,n,r,o)}),e.setStoreName=((e,t)=>{const n=a(t,e.domainName);e.shortName=t,e.compositeName?(e.compositeName.path=n.path,e.compositeName.shortName=n.shortName,e.compositeName.fullName=n.fullName):e.compositeName=n}),e.step=B,e.version="19.1.0",e.warning=ue,e.withProps=((e,t)=>n=>t(e.getState(),n)),Object.defineProperty(e,'__esModule',{value:1})});
//# sourceMappingURL=effector.umd.js.map
